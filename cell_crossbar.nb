ClearAll["Global`*"];


m=5; n=7; Cnds={{0.0014814815,0.0015772871,0.0043290043,0.0010604454,0.0034482759,0.0023752969,0.0024390244},{0.0030581040,0.0016313214,0.0037037037,0.0018867925,0.0025445293,0.0057803468,0.0010526316},{0.0044642857,0.0046082949,0.0014265335,0.0010070493,0.0044444444,0.0020618557,0.0043478261},{0.0036496350,0.0019455253,0.0030487805,0.0026315789,0.0015600624,0.0192307692,0.0019920319},{0.0024390244,0.0026178010,0.0011778563,0.0018083183,0.0020661157,0.0126582278,0.0020161290}}; Gwl=0.2000000000; Gbl=0.2000000000; Vin={28,29,11,15,26};

HspcOut={26.3719,27.0442,10.2545,13.6951,23.9066,3.4975,3.3281,2.796,2.0974,1.1873,24.9133,25.4511,9.6755,12.6017,22.0903,2.6431,2.4675,2.1044,1.5669,0.921964,23.6303,24.0454,9.2709,11.6158,20.551,4.1532,3.7316,2.9338,2.0909,1.1027,22.7689,23.0159,8.9115,10.775,19.1263,1.8887,1.778,1.4669,1.1184,0.642737,22.0182,22.1867,8.5897,10.0613,17.8687,3.3068,2.9842,2.4173,1.7132,0.944039,21.5901,21.6019,8.4049,9.4127,16.786,5.0982,4.9024,4.2239,3.5022,2.2123,21.3579,21.4997,8.2633,9.3324,16.6256,2.3156,2.0834,1.749,1.273,0.716675};

GPm=Table[Table[If[(i+(k-1)*2*n)==j, 1,0],{i,2*n},{j,2*m*n}],{k,1,m}];
(*Pm=Table[If[i==j, 1,0],{i,2*m*n},{j,2*m*n}]//MatrixForm (*Identity matrixs*)*)
(*GPm[[3]]//MatrixForm*)
Pm=Table[0,{i,2*m*n},{j,2*m*n}];
For[i=1,i<=m,i++,
For[j=1,j<=n,j++,
Pm[[2*m*(j-1)+i]]=GPm[[i,2*(j-1)+1]];
Pm[[2*m*(j-1)+m+i]]=GPm[[i,2*(j-1)+2]];
]
]
AbsoluteTiming[
Ivec=Table[0,{i,2*m*n}];
Gm=Table[0,{i,2*m*n},{j,2*m*n}];
For[i=1,i<=m,i++,
For[j=1,j<=n,j++,
(*Print["i=",i," j=",j]*)
If[j==1,
Gm[[(j-1)*m+i,2*n*(i-1)+1]]=2*Gwl+Cnds[[i,j]];
Gm[[(j-1)*m+i,2*n*(i-1)+3]]=-Gwl;
Gm[[(j-1)*m+i,2*n*(i-1)+2]]=-Cnds[[i,j]];
(*Ivec[[(j-1)*m+i]]=Gwl*Subscript[V,i];*)
Ivec[[(j-1)*m+i]]=Gwl*Vin[[i]];
,(*else*)
If[j==n,
Gm[[(j-1)*m+i,2*n*(i-1)+2*(j-1)+1]]=Gwl+Cnds[[i,j]];
Gm[[(j-1)*m+i,2*n*(i-1)+2*(j-2)+1]]=-Gwl;
Gm[[(j-1)*m+i,2*n*(i-1)+2*(j-1)+2]]=-Cnds[[i,j]];
,(*else*)
Gm[[(j-1)*m+i,2*n*(i-1)+2*(j-1)+1]]=2Gwl+Cnds[[i,j]];
Gm[[(j-1)*m+i,2*n*(i-1)+2*(j-2)+1]]=-Gwl;
Gm[[(j-1)*m+i,2*n*(i-1)+2*(j)+1]]=-Gwl;
Gm[[(j-1)*m+i,2*n*(i-1)+2*(j-1)+2]]=-Cnds[[i,j]];
,]
,]
If[i==1,
Gm[[(j-1)*m+i+m*n,2*(j-1)+2]]=Gbl+Cnds[[i,j]];
Gm[[(j-1)*m+i+m*n,2*n+2*(j-1)+2]]=-Gbl;
Gm[[(j-1)*m+i+m*n,2*(j-1)+1]]=-Cnds[[i,j]];
,(*else*)
If[i==m,
Gm[[(j-1)*m+i+m*n,2*n*(i-1)+2*(j-1)+2]]=2*Gbl+Cnds[[i,j]];
Gm[[(j-1)*m+i+m*n,2*n*(i-2)+2*(j-1)+2]]=-Gbl;
Gm[[(j-1)*m+i+m*n,2*n*(i-1)+2*(j-1)+1]]=-Cnds[[i,j]];
,(*else*)
Gm[[(j-1)*m+i+m*n,2*n*(i-1)+2*(j-1)+2]]=2*Gbl+Cnds[[i,j]];
Gm[[(j-1)*m+i+m*n,2*n*(i)+2*(j-1)+2]]=-Gbl;
Gm[[(j-1)*m+i+m*n,2*n*(i-2)+2*(j-1)+2]]=-Gbl;
Gm[[(j-1)*m+i+m*n,2*n*(i-1)+2*(j-1)+1]]=-Cnds[[i,j]];
,
]
,
]
]
]

LinearSolve[Gm,Ivec];
]
MtmOut=Pm.N[LinearSolve[Gm,Ivec]];
ListPlot[{MtmOut-HspcOut}]
